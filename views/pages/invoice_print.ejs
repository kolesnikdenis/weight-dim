<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Latest compiled and minified CSS -->
	 <link rel="stylesheet" href="/public/bootstrap_4.1.3/css/bootstrap.min.css">
	 <script src="https://unpkg.com/ionicons@4.2.2/dist/ionicons.js"></script>
	<script>

var fun_filter_goods  = (in_array_filter,in_obj)=>{
    //var val = Object.values(in_obj);
    //var key=Object.keys(in_obj);
    var work_obj=in_obj;
    var out={}
    if (in_array_filter.length>0) {
        for (let [key, value] of Object.entries(work_obj)) {
            var test = true;
            for ( var ii=0; in_array_filter.length >ii; ii++ ){
                if (value==in_array_filter[ii] ) {
                    test=false;
                }
            }
            if (test ) { out[key] = value; }{/*console.log("del goods:", value )*/}
        }

    }
    else {
        out=in_obj;
    }/*
    if ( val.length >0 && in_array_filter.length>0)
        for ( var i =0; val.length>i; i++){
            var test = true;
            for ( var ii=0; in_array_filter.length >ii; ii++ ){
                if (val[i] ==in_array_filter[ii] ) {
                    test=false;
                }
            }
            if (test ) { out[key[i]] = val[i]; }{console.log("del:", val[i] )}

        }
    else { out = in_obj;  }*/
    return out;
}


var fun_rename_goods = (filter,in_obj)=>{
    console.log(in_obj);
    var  work_obj = in_obj;
    for (let [key, value] of Object.entries(work_obj)) {
        //console.log(key,"find value:", value);
        for (let [find_val, set_val] of Object.entries(filter)) {
            if (find_val == value) {
                //console.log("меняем на set_val:",set_val);
                work_obj[key]=set_val;
            }
        }
    }
    return work_obj;
}
var  funFilter = (in_array_filter,in_obj)=>{
    var val = Object.values(in_obj);
    var key=Object.keys(in_obj);
    var out={}
    if ( val.length >0 && in_array_filter.length>0)
        for ( var i =0; val.length>i; i++){
            var test = true;
            for ( var ii=0; in_array_filter.length >ii; ii++ ){
                if (val[i] ==in_array_filter[ii] ) {
                    test=false;
                }
            }
            if (test ) { out[key[i]] = val[i]; }{/*console.log("del:", val[i] )*/}

        }
    else { out = in_obj;  }
    return out;
}
</script>
<!-- 22.11.18 -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

<!-- end 22.11.18 -->


<!--  Open Sans Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">

<!-- Optional theme -->
	<link rel="stylesheet" href="/public/bootstrap_4.1.3/css/bootstrap-reboot.min.css">
 	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<!-- Latest compiled and minified JavaScript -->
	<script src="/public/bootstrap_4.1.3/js/bootstrap.min.js"></script>
  <!-- bootstrap-select -->
  <link rel="stylesheet" href="https://cdn.rawgit.com/infostreams/bootstrap-select/fd227d46de2afed300d97fd0962de80fa71afb3b/dist/css/bootstrap-select.min.css" />
  <script src="https://cdn.rawgit.com/infostreams/bootstrap-select/fd227d46de2afed300d97fd0962de80fa71afb3b/dist/js/bootstrap-select.min.js"></script>
<!-- FontAwesome -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">

<!-- Main CSS -->
	<link rel="stylesheet" href="/public/css/main.css">
</head>

<script>
  $( document ).ready(function() {
    var t="shipment";
    console.log(t);
    var header_text;
    if (t=="shipment")
       header_text="Отгрузка"
    else 
       header_text="Приход товара"
      $(".header_text").append(header_text);
});
  
</script>


<!--
json: <%- json %>
price: <%- price %>
print: <%- print %>
-->
<style>
#lline{
 display: flex;
 flex-flow: row-reverse;
}

@media print
{
 .noprint {display:none;}
}

</style>

<header class="head-points noprint">
  <div class="container">
    <div class="row">
        <div class="col-2">
          <a href="javascript:window.history.back();" class="back"> 
            <img src="../../public/img/back.svg" astore_pricelt="назад">
          </a>
        </div>
        <div class="col-8">
          <h1>Накладная</h1>
        </div>
    </div>
  </div>
</header> 


<div class="container">
    <div class="row">
        <div class="col-12">
            <div id=headr_div>
                <div id=line class="line-title">
                    <h1 id=p>Перемещение запасов № </h1>
                    <div id=number>__</div>  от 
                    <div id=from_date>2018-11-11 02:42:17</div>
                </div>
                <div class="d-flex wrapper-direction">
                    <div id=line>От кого: 
                    <div id=from_contragen_store class="direction_to">отправитель</div>
                </div>
                <div id=line class="line-recipient">Кому:  
                    <div id=to_contragen_store class="direction_to">получатель</div>
                </div>
                </div>
            </div>
            <table id=table width='100%' class="table-invoice">
                <thead>
                    <tr width="100%">
                        <th>№</th>
                        <!-- <th>Код</th> -->
                        <th>Товары</th>
                        <th>Количество</th>
                        <th>Цена</th> 
                        <th>Стоимость</th>
                    </tr>
                </thead>
                <tbody id="table-invoice__info"></tbody>
            </table>

            <div id=footer_div>
                <div id=lline >
                    <div id=full_cost>123</div>
                </div>
                <div id=line>
                    <div id=responsible_from>Отпустил: ____________________________</div> 
                    <div id=responsible_to>Получил: ____________________________</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
var obj=(<%- json  %>);
var goods_chicken=(<%- goods_chicken %>);

var store_price=<%- (!!locals.price)?price:'{}' %>;
var full_summ=0;
//$('#table').append("<tr><td>1</td><td></td><td>1</td><td>1</td><td>1</td></tr>");
$("#from_date").text(obj.dst.create_data_time);
console.log(obj)
if ( obj.type == "shipment") {
    $("#from_contragen_store").text("Основной склад");
    $("#to_contragen_store").text(obj.dst.name);
}else {
    $("#from_contragen_store").text(obj.dst.name);
    $("#to_contragen_store").text("Основной склад");
}

function add(in_obj) {
   var num_product=0;
   var p = Object.keys(in_obj);
   console.log(p);
   for ( var pi=0; pi<p.length; pi++ ) {
    var category_product=p[pi];
    var product = in_obj[category_product];
    var i=0;
    for (var k in product) {
        if (product.hasOwnProperty(k)) {
            i++;
            var summ=0;
		    var price=0;
            if ( obj.type == "arrival")
                $("#from_contragen_store").text(obj.contragent_name[category_product][k]);
            if (typeof(product[k]) === "object") {
                summ = 0;
                for (var t = 0; t <product[k].length; t++) {
                    var st = product[k][t];
                    summ = parseFloat(summ) + parseFloat(st);

                }
            }
            if ( store_price && k && store_price[k] && store_price[k].Price) {
                price=store_price[k].Price;
                console.log("price:", price, " descr:", store_price[k].Description)
            }else {
                price=0;
            }

            full_summ += price*summ;
            summ=summ.toFixed(3);

	    if (summ>0) {
            $('#table-invoice__info').append("<tr><td>" + num_product + "</td><td>" + goods_chicken[category_product].product[k] + "</td><td>" + summ + " кг</td><td>" + price.toFixed(3) + "</td><td>" + (price * summ).toFixed(3) + "</td></tr>");
            num_product++;
        }

	}
    }
   }
}
add(obj.shipment);
full_summ= full_summ.toFixed(3);
$("#full_cost").text("Итого: " +full_summ+" грн");
function save_and_del_tmp(){
    alert("save and del :D");
    $.ajax({
        url: "/send_to_1c",
        type: "GET",
        cache: false,
        timeout: 5000,
        complete: function() {
            console.log('process complete');
        },
        success: function(data) {
            console.log(data);
            window.print();
            alert("все... конец) вы типа все сделали ");
            console.log('process sucess');
        },
        error: function() {
            console.log("какая то ошибка")
            console.log('process error');
        },
    });

}

(function() {
    var beforePrint = function() {
        console.log('Functionality to run before printing.');
    };

    var afterPrint = function() {
        console.log('Functionality to run after printing');
	window.location.href = "/";
    };

    if (window.matchMedia) {
        var mediaQueryList = window.matchMedia('print');
        mediaQueryList.addListener(function(mql) {
            if (mql.matches) {
                beforePrint();
            } else {
                afterPrint();
            }
        });
    }

    window.onbeforeprint = beforePrint;
    window.onafterprint = afterPrint;

}());


</script>

    <div class="container">
        <div class="row">
            <div class=noprint>
                <a href="javascript:save_and_del_tmp()" class="btn btn-prints">
                    <img src="../../public/img/printer.svg" alt="печать">
                </a>  
                <a href="/" class="btn btn-weight_fix">Сохранить</a> 
            </div>
        </div>
    </div>
</body